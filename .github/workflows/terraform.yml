name: Terrafom CI/CD for EKS Cluster 

on:
  push:
    branches:
      - main
  workflow_dispatch: 
    inputs:
        action:
          description: 'Select Apply to apply the changes'
          required: true
          type: choice
          options:
            - apply
            - destroy
permissions:
  id-token: write
  contents: read

env:
  TF_VERSION: ${{ vars.TF_VERSION  }}
  TF_WORKDIR: ${{ vars.TF_WORKDIR  }}
  TF_region: ${{ vars.TF_REGION  }}
  EKS_CLUSTER_NAME: ${{ vars.EKS_CLUSTER_NAME  }}
  MANIFEST_PATH: ${{ vars.MANIFEST_PATH }}
concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate: 
    name: fmt init validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{env.TF_VERSION }}
      - name: Terraform fmt
        run: terraform fmt -check
      - name: Terraform init
        run: terraform -chdir="${{env.TF_WORKDIR}}" init -backend=false -input=false
      - name: Terraform validate
        run: terraform -chdir="${{env.TF_WORKDIR}}" validate
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    env:
        PLAN_ROLE_ARN: ${{ secrets.PLAN_ROLE_ARN }}
        TF_VAR_aws_profile: ""
    steps:
        - uses: actions/checkout@v4
        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: ${{env.TF_VERSION }}
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: ${{ secrets.PLAN_ROLE_ARN }}
            role-session-name: GitHubActions-TerraformPlan
            aws-region: ${{ env.TF_region }}
        - name: terraform init 
          run: terraform -chdir="${{env.TF_WORKDIR}}" init -input=false 
        - name: terraform plan
          run: terraform -chdir="${{env.TF_WORKDIR}}" plan -out=tfplan -input=false -lock=false
        - name: Upload plan artifact
          if: github.event_name == 'workflow_dispatch'
          uses: actions/upload-artifact@v4
          with:
           name: tfplan
           path: ${{ env.TF_WORKDIR }}/tfplan
           if-no-files-found: error
           retention-days: 3
  apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: plan
    if: github.event.inputs.action == 'apply' && (github.event_name != 'pull_request')
    env:
        APPLY_ROLE_ARN: ${{ secrets.APPLY_ROLE_ARN }}
        TF_VAR_aws_profile: ""
    steps:
        - uses: actions/checkout@v4
        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: ${{env.TF_VERSION }}
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: ${{ secrets.APPLY_ROLE_ARN }}
            role-session-name: GitHubActions-TerraformApply
            aws-region: ${{ env.TF_region }}
        - name: terraform init
          run: terraform -chdir="${{env.TF_WORKDIR}}" init -input=false
        - name: Download plan artifact
          uses: actions/download-artifact@v4
          with:
            name: tfplan
            path: ${{ env.TF_WORKDIR }} 
        - name: terraform apply
          run: terraform -chdir="${{env.TF_WORKDIR}}" apply -auto-approve tfplan
        - name: Install kubectl
          uses: azure/setup-kubectl@v4
          with:
            version: v1.30.3
        - name: Deploy via SSM on bastion
          run: |
            set -e
            BASTION_ID=$(aws ec2 describe-instances \
              --region ${{ env.TF_region }} \
              --filters "Name=tag:Name,Values=eks-bastion" "Name=instance-state-name,Values=running" \
              --query "Reservations[].Instances[].InstanceId" --output text)
            if [ -z "$BASTION_ID" ] || [ "$BASTION_ID" = "None" ]; then
              echo "No running bastion instance found"; exit 1
            fi

            CMD_ID=$(aws ssm send-command \
              --region ${{ env.TF_region }} \
              --document-name "AWS-RunShellScript" \
              --comment "Deploy simple-nginx" \
              --instance-ids "$BASTION_ID" \
              --parameters commands=["export KUBECONFIG=/root/.kube/config","unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY","aws eks update-kubeconfig --region ${{ env.TF_region }} --name ${{ env.EKS_CLUSTER_NAME }}","kubectl apply --validate=false -f https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/Dev/simple-nginx.yaml"] \
              --query "Command.CommandId" --output text)

            # Czekaj na wykonanie komendy na bastionie
            aws ssm wait command-executed \
              --region ${{ env.TF_region }} \
              --command-id "$CMD_ID" \
              --instance-id "$BASTION_ID"

            STATUS=$(aws ssm get-command-invocation \
              --region ${{ env.TF_region }} \
              --command-id "$CMD_ID" \
              --instance-id "$BASTION_ID" \
              --query "Status" --output text)
            echo "SSM command status: $STATUS (CommandId: $CMD_ID, Instance: $BASTION_ID)"
            if [ "$STATUS" != "Success" ]; then
              aws ssm get-command-invocation \
                --region ${{ env.TF_region }} \
                --command-id "$CMD_ID" \
                --instance-id "$BASTION_ID" \
                --query "{StdOut:StandardOutputContent,StdErr:StandardErrorContent}" \
                --output text
              exit 1
            fi
  destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy' && (github.event_name != 'pull_request')
    env:
        DESTROY_ROLE_ARN: ${{ secrets.DESTROY_ROLE_ARN }}
        TF_VAR_aws_profile: ""
    steps:
        - uses: actions/checkout@v4
        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: ${{env.TF_VERSION }}
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: ${{ secrets.DESTROY_ROLE_ARN }}
            role-session-name: GitHubActions-TerraformDestroy
            aws-region: ${{ env.TF_region }}
        - name: Configure kubeconfig for EKS
          run: aws eks update-kubeconfig --region ${{ env.TF_region }} --name ${{ env.EKS_CLUSTER_NAME }}
        - name: Delete workload from EKS
          run: kubectl delete --ignore-not-found -f ${{ env.TF_WORKDIR }}/${{env.MANIFEST_PATH }}
        - name: terraform init              
          run: terraform -chdir="${{env.TF_WORKDIR}}" init -input=false
        - name: terraform destroy           
          run: terraform -chdir="${{env.TF_WORKDIR}}" destroy -auto-approve   
